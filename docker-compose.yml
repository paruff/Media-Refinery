services:
  # Media Refinery - The main application
  media-refinery:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: media-refinery
    labels:
      - "com.media-refinery.description=Main media processing application"
      - "com.media-refinery.service=core"
    volumes:
      - ./input:/input
      - ./output:/output
      - ./work:/work
      - ./config.yaml:/app/config.yaml
    environment:
      - TZ=America/New_York
      # OpenTelemetry Configuration
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://host.docker.internal:4318
      - OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
      - OTEL_SERVICE_NAME=media-refinery
      - OTEL_RESOURCE_ATTRIBUTES=service.namespace=media-processing,service.version=1.0.0
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=otlp
      - OTEL_LOGS_EXPORTER=otlp
      # Loki logging
      - LOKI_URL=http://host.docker.internal:3100/loki/api/v1/push
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "com.media-refinery.service"
        tag: "{{.Name}}/{{.ID}}"
    depends_on:
      beets:
        condition: service_healthy
      tdarr:
        condition: service_healthy
      radarr:
        condition: service_healthy
      sonarr:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - media-refinery-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f media-refinery || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Beets - Music library management
  beets:
    image: linuxserver/beets:latest
    container_name: beets
    labels:
      - "com.media-refinery.description=Music library management"
      - "com.media-refinery.service=audio"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - ./config/beets:/config
      - ./input:/music
      - ./output:/output
    ports:
      - "8337:8337"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - media-refinery-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8337"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Tdarr - Transcoding automation
  tdarr:
    image: haveagitgat/tdarr:latest
    container_name: tdarr
    labels:
      - "com.media-refinery.description=Transcoding automation"
      - "com.media-refinery.service=transcoding"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
      - internalNode=true
      - nodeID=MainNode
    volumes:
      - ./config/tdarr/server:/app/server
      - ./config/tdarr/configs:/app/configs
      - ./config/tdarr/logs:/app/logs
      - ./input:/input
      - ./output:/output
      - ./work/tdarr:/temp
    ports:
      - "8265:8265"  # WebUI
      - "8266:8266"  # Server
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - media-refinery-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8265"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Radarr - Movie management
  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    labels:
      - "com.media-refinery.description=Movie organization and metadata"
      - "com.media-refinery.service=movies"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - ./config/radarr:/config
      - ./input/movies:/movies
      - ./output/movies:/output
    ports:
      - "7878:7878"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - media-refinery-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Sonarr - TV show management
  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    labels:
      - "com.media-refinery.description=TV show organization and metadata"
      - "com.media-refinery.service=tv"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
    volumes:
      - ./config/sonarr:/config
      - ./input/tv:/tv
      - ./output/tv:/output
    ports:
      - "8989:8989"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - media-refinery-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Optional: Plex Media Server
  plex:
    image: plexinc/pms-docker:latest
    container_name: plex
    labels:
      - "com.media-refinery.description=Media server"
      - "com.media-refinery.service=streaming"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - VERSION=docker
    volumes:
      - ./config/plex:/config
      - ./output:/data
    ports:
      - "32400:32400"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - media-refinery-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:32400/identity"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

networks:
  media-refinery-network:
    driver: bridge

volumes:
  input:
  output:
  work:
